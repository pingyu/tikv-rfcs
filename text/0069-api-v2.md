# TiKV API V2

## Motivation

`API V2` is a set of breaking changes that aim to solve serval issues with current RawKV (hereafter referred to as `API V1`):

1. RawKV is not safe to use along with TxnKV. If it get solved, TiDB will be able to support RawKV as the table's storage engine, which will enrich TiDB's use cases.
2. RawKV TTL is controlled by TiKV configuration. Switching the configuration will cause data corruption in silence.
3. RawKV TTL is hardcoded into the value, therefore it's hard to add more metadata afterward.

## Detailed Design

### New key-value codec

This RFC introduces a new key encoding to RawKV and TxnKV, and a new value encoding to RawKV, which will allow the RawKV to be used along with TxnKV and also allow TiKV to flexibly add meta, e.g. the TTL, to a RawKV value.

Since API V2 changed the storage encoding, it will be not compatible to switch between `API V1` and `API V2` while there are non-TiDB data in TiKV. TiDB data is specially treated in order to not be affected by the change.

#### Key Encode

Once `API V2` is enabled, keys will start with either:

1. `m` and `t`: TxnKV key that will only be used by TiDB.
2. `x`: TxnKV key.
3. `r`: RawKV key.

`x`, `r` are mode prefixes that indicates the mode the key is belonging to. The mode prefix is ahead of the keyspace id so that TiKV and clients are able to quickly check the mode without parsing the keyspace id in varint format.

In API V2, all keys will be encoded according to `Memory Comparable Encoding`, the same as txn keys in API V1.

#### RawKV Value Encode

If the key has RawKV prefix `r`, then the value can be either:

1. `{data}{0x0}`
2. `{data}{TTL expire timestamp}{0x1}`

### How to safely enable API V2

#### Upgrade

Upgrade from `API V1` to `API V2` is a simple process:

1. Update TiKV, TiDB, and PD to the version that supports `API V2`.
2. Ensure that all the keys in TiKV are written by TiDB, which are prefixed with `m` or `t`. Delete if any. Or else the step 3 will fail.
3. Enable `API V2` in TiKV config file and restart TiKV (User should take the responsibility to offline all tikv clients excluding TiDB. Or set by online config change API (Not proposed in this RFC, but is good to have).

#### Downgrade

Downgrade from `API V2` to `API V1` is also simple:

1. Ensure that all the keys in TiKV are written by TiDB, which are prefixed with `m` or `t`. Delete if any.
2. Disable `API V2` in TiKV config file and restart TiKV (User should take the responsibility to offline all tikv clients excluding TiDB). Or set by online config change API (Not proposed in this RFC, but is good to have).

#### Data migration

It's reasonable to provide a way to import and export non-TiDB data in TiKV during the upgrade or downgrade. On TiKV before 4.0, the only way to do that is `scan` and `batch_put` on the client. After 4.0, TiKV start to support importing SST file into TxnKV, and after 5.1, importing on RawKV is also supported. You can find more information in [`RFC: Online Bulk Load for RawKV`](https://github.com/tikv/rfcs/pull/72).

## Implementation Details

### kvproto

```proto
// kvrpcpb.proto

message Context {
    // ... omited other fields

    // API version implies the encode of the key and value.
    APIVersion api_version = 21;
}

// The API version the server and the client is using.
// See more details in https://github.com/tikv/rfcs/blob/master/text/0069-api-v2.md.
enum APIVersion {
    // Mainly for TxnKV and not safe to use RawKV along with TxnKV.
    //
    // V1 server only accepts V1 requests. Except that the V1 raw requests with TTL
    // will be rejected.
    V1 = 0;
    // Only RawKV is available, and then 8 bytes representing the unix timestamp in
    // seconds for expiring time will be append to the value of all RawKV kv pairs.
    //
    // ------------------------------------------------------------
    // | User value     | Expire Ts                               |
    // ------------------------------------------------------------
    // | 0x12 0x34 0x56 | 0x00 0x00 0x00 0x00 0x00 0x00 0xff 0xff |
    // ------------------------------------------------------------
    //
    // V1TTL server only accepts V1 raw requests.
    // V1 client should not use `V1TTL` in request. V1 client should always send `V1`.
    V1TTL = 1;
    // TxnKV keys start with `x{keyspace id}`, `m`, or `t`.
    //
    // RawKV keys must be in `default` CF and all start with `r{keyspace id}` prefix,
    // where the keyspace id is in varint format (little endian), whose bytes expect
    // the last one always sets the most significant bit to 1.
    //
    // The last byte in the raw value must be a meta flag. For example:
    //
    // --------------------------------------
    // | User value     | Meta flags        |
    // --------------------------------------
    // | 0x12 0x34 0x56 | 0x00 (0b00000000) |
    // --------------------------------------
    //
    // As shown in the example below, the least significant bit of the meta flag
    // indicates whether the value contains 8 bytes expire ts at the very left to the
    // meta flags.
    //
    // --------------------------------------------------------------------------------
    // | User value     | Expire Ts                               | Meta flags        |
    // --------------------------------------------------------------------------------
    // | 0x12 0x34 0x56 | 0x00 0x00 0x00 0x00 0x00 0x00 0xff 0xff | 0x01 (0b00000001) |
    // --------------------------------------------------------------------------------
    //
    // V2 server accpets V2 requests and V1 txn requests that statrts with TiDB key
    // prefix (`m` and `t`).
    V2 = 2;
}
```

```proto
// raft_serverpb.proto

message StoreIdent {
    // ... omited other fields
    
    kvrpcpb.APIVersion api_version = 3;
}
```

```proto
// brpb.proto

message BackupMeta {
     // ... omited other fields

    kvrpcpb.APIVersion api_version = 18;
}

message BackupResponse {
    // ... omited other fields
    
    kvrpcpb.APIVersion api_version = 5;
}
```

### TiKV Server

In TiKV config file, add a new configuration `storage.api_version`.

If the API version in `StorgeIdent` mismatches with `storage.api_version` in the config, it means that the user is switching the API version, therefore TiKV will check if there is any non-TiDB data in stoarge, and eventually save the new API version in `StoreIdent`.

If `storage.api_version=V2`:

- Use the new value encoding in `RawStore` and `sst_importer`.

- Only allow RawKV to access `default` CF.

- If the request's context has `api_version=1`:
  - Reject the request unless it's a TxnKV request and the keys starting with `m` or `t`.

- If the request's context has `api_version=2`:
  - Only allow the key that has RawKV prefix for RawKV requests.
  - Only allow the key that has TxnKV prefix for TxnKV requests.

If `storage.api_version=V1TTL`:

- Reject all requests with `api_version=2` in the context.
- Reject all TxnKV requests because the raw tll encoding in V1TTL will corrupt TxnKV data.

If `storage.api_version=V1`:

- Reject all requests with `api_version=2` in the context.

### TiKV Client

Provide two modes for users:

- V2:
  - Prepend `x` before TxnKV keys or prepend `r` before RawKV keys.
  - Set `api_version=2` in `kvrpcpb.Context`.
  - Disallow specifying `cf` in `RawClient`.

- V1:
  - Behaves jusk like current client.
  - Set `api_version=1` in `kvrpcpb.Context`.

Listed below is the compatibility matrix:

|                       | V1 Server | V1TTL Server | V2 Server |
| --------------------- | --------- | ------------ | --------- |
| V1 RawClient          | Raw       | Raw          | Error     |
| V1 RawClient with TTL | Error     | Raw          | Error     |
| V1 TxnClient          | Txn       | Error        | Error     |
| V1 TiDB               | TiDB Data | Error        | TiDB Data |
| V2 RawClient          | Error     | Error        | Raw       |
| V2 TxnClient          | Error     | Error        | Txn       |

### CDC / BR

Since all access to TiDB is unchanged during the upgrade, CDC and BR should work the same after upgrade/downgrade.

### tikv-ctl

Read `api_version` in kvdb and decode data using the corresponding version.

### TiDB

Upgrade to the latest TiKV Go Client and use `V1` mode.

## Unresolved questions
